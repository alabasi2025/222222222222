# توثيق عملية شراء وصرف الديزل

## نظرة عامة

هذا الملف يوثق عملية شراء الديزل من المورد وإيصاله للمحطة، ثم صرفه للاستهلاك.

---

## تدفق العملية الكاملة

### 1. الشراء من المورد

**السيناريو**: شراء ديزل من مورد (مورد ديزل) للمحطة التابعة

**الخطوات**:
1. فتح صفحة **المشتريات** (`Purchases.tsx`)
2. إنشاء فاتورة شراء جديدة:
   - اختيار المورد (مورد الديزل)
   - اختيار الصنف (الديزل)
   - اختيار المستودع (مستودع المحطة)
   - إدخال الكمية والسعر
   - تحديد نوع الفاتورة:
     - **أجلاً**: سيتم تسجيل دين للمورد
     - **نقداً**: سيتم الدفع فوراً

3. **إذا كان الدفع نقداً**:
   - اختيار طريقة الدفع: **الصرافين (Exchange)**
   - اختيار الصراف المحدد
   - سيتم **تلقائياً** إنشاء:
     - حركة مخزون (stock movement) بنوع `in` و `referenceType: 'purchase'`
     - قيد محاسبي:
       - مدين: حساب المخزون
       - دائن: حساب المورد
     - سند صرف تلقائي من الصرافين للمورد
     - تحديث رصيد الصرافين (يُخصم المبلغ)

4. **إذا كان الدفع أجلاً**:
   - يتم إنشاء حركة المخزون والقيد المحاسبي فقط
   - لا يتم إنشاء سند صرف
   - يتم تسجيل الدين في حساب المورد

5. **إيصال الديزل للمحطة**:
   - الموظف يذهب مع الوايت (الشاحنة) لحمل الكمية
   - الديزل يدخل **المخزن** في المحطة

---

### 2. صرف الديزل للاستهلاك

**السيناريو**: صرف الديزل من المخزن لحساب استهلاك الديزل

**الخطوات**:
1. فتح صفحة **حركات المخزون** (`StockMovements.tsx`)
2. إنشاء حركة صادر جديدة:
   - نوع الحركة: **صادر (out)**
   - الصنف: الديزل
   - المستودع: مستودع المحطة
   - الكمية: الكمية المراد صرفها
   - **حساب الصرف (toAccountId)**: اختيار حساب استهلاك الديزل

3. **تلقائياً** يتم:
   - تقليل الكمية في المخزن
   - إنشاء قيد محاسبي:
     - مدين: حساب استهلاك الديزل (COGS)
     - دائن: حساب المخزون

---

## القيود المحاسبية التلقائية

### عند الشراء (أجلاً أو نقداً)

```
مدين: حساب المخزون (Stock Account)
دائن: حساب المورد (Supplier Account)
```

### عند الشراء النقدي من الصرافين

بالإضافة للقيد أعلاه، يتم إنشاء **سند صرف تلقائي**:

```
سند صرف من: الصرافين
سند صرف إلى: المورد
المبلغ: قيمة الديزل المشترى
```

وتحديث رصيد الصرافين (يُخصم المبلغ).

### عند صرف الديزل للاستهلاك

```
مدين: حساب استهلاك الديزل (COGS Account)
دائن: حساب المخزون (Stock Account)
```

---

## أمثلة على الاستخدام

### مثال 1: شراء ديزل نقداً (4 حملات)

1. **فاتورة شراء**:
   - المورد: مورد الديزل ABC
   - الصنف: ديزل
   - الكمية: 4000 لتر
   - السعر: 500 ر.ي/لتر
   - الإجمالي: 2,000,000 ر.ي
   - نوع الفاتورة: نقداً
   - طريقة الدفع: الصرافين
   - الصراف: صراف الخليج

2. **ما يتم إنشاؤه تلقائياً**:
   - ✅ حركة وارد (4000 لتر في المخزن)
   - ✅ قيد محاسبي: مدين المخزون 2,000,000 ر.ي، دائن المورد 2,000,000 ر.ي
   - ✅ سند صرف رقم `PAY-OUT-xxxxx` من صراف الخليج لمورد الديزل ABC بقيمة 2,000,000 ر.ي
   - ✅ تحديث رصيد صراف الخليج (يُخصم 2,000,000 ر.ي)

3. **إيصال الديزل**: الموظف يذهب مع الوايت لحمل الديزل ويوصله للمخزن

4. **صرف للاستهلاك** (لاحقاً):
   - حركة صادر: 1000 لتر
   - حساب الصرف: حساب استهلاك الديزل
   - ✅ قيد محاسبي: مدين استهلاك الديزل 500,000 ر.ي، دائن المخزون 500,000 ر.ي
   - ✅ تقليل المخزون (3000 لتر متبقي)

---

### مثال 2: شراء ديزل أجلاً

1. **فاتورة شراء**:
   - المورد: مورد الديزل XYZ
   - الكمية: 2000 لتر
   - السعر: 500 ر.ي/لتر
   - الإجمالي: 1,000,000 ر.ي
   - نوع الفاتورة: **أجلاً**

2. **ما يتم إنشاؤه تلقائياً**:
   - ✅ حركة وارد (2000 لتر في المخزن)
   - ✅ قيد محاسبي: مدين المخزون 1,000,000 ر.ي، دائن المورد 1,000,000 ر.ي
   - ❌ لا يتم إنشاء سند صرف (الدفع أجلاً)

3. **الدفع لاحقاً**: يمكن إنشاء سند صرف يدوياً من صفحة سندات الصرف لدفع المبلغ للمورد

---

## الحقول المطلوبة في النظام

### عند إنشاء فاتورة شراء نقدية

- `supplierId`: معرف المورد
- `itemId`: معرف الصنف (الديزل)
- `warehouseId`: معرف المستودع
- `quantity`: الكمية
- `unitCost`: سعر الوحدة
- `invoiceType`: `"cash"` (نقداً)
- `paymentMethod`: `"exchange"` (الصرافين)
- `paymentAccountId`: معرف الصراف المحدد
- `currency`: العملة (YER/SAR/USD)

### عند صرف الديزل للاستهلاك

- `type`: `"out"` (صادر)
- `itemId`: معرف الديزل
- `warehouseId`: معرف المستودع
- `quantity`: الكمية المراد صرفها
- `toAccountId`: **حساب استهلاك الديزل** (مطلوب)

---

## ملاحظات مهمة

1. **الحوالات المتعددة**: يمكن إنشاء حوالات لعدة حملات (مثلاً قيمة 4 حملات) - النظام يدعم المبالغ المجمعة.

2. **الربط التلقائي**: عند الشراء النقدي من الصرافين، يتم ربط سند الصرف بفاتورة الشراء عبر `reference`.

3. **تحديث الأرصدة**: 
   - عند الشراء النقدي: يتم تحديث رصيد الصرافين تلقائياً
   - عند الصرف للاستهلاك: يتم تحديث المخزون تلقائياً

4. **القيود المحاسبية**: جميع القيود المحاسبية يتم إنشاؤها تلقائياً ولا تحتاج لتدخل يدوي.

5. **التوثيق**: يمكن تتبع جميع العمليات من خلال:
   - صفحة المشتريات (للفواتير)
   - صفحة حركات المخزون (لحركات الدخول والخروج)
   - صفحة سندات الصرف (لحوالات الصرافين)
   - صفحة القيود اليومية (لجميع القيود المحاسبية)

---

## الملفات التقنية

### الملفات المعدلة

1. **`server/db/schema.ts`**:
   - إضافة حقل `bankWalletId` إلى جدول `paymentVouchers`

2. **`server/routes/payments.ts`**:
   - دعم تحديث أرصدة `banksWallets` عند استخدام الصرافين
   - دعم `bankWalletId` في إنشاء السندات

3. **`server/routes/stockMovements.ts`**:
   - إضافة منطق إنشاء سند صرف تلقائي عند الشراء النقدي من الصرافين
   - تحديث رصيد الصرافين تلقائياً

---

## الاختبار

لاختبار العملية:

1. إنشاء فاتورة شراء ديزل نقداً من الصرافين
2. التحقق من:
   - ✅ إنشاء حركة المخزون
   - ✅ إنشاء القيد المحاسبي
   - ✅ إنشاء سند الصرف تلقائياً
   - ✅ تحديث رصيد الصرافين
3. إنشاء حركة صرف ديزل للاستهلاك
4. التحقق من:
   - ✅ تقليل المخزون
   - ✅ إنشاء القيد المحاسبي

---

**تاريخ التوثيق**: 2026-01-16  
**آخر تحديث**: 2026-01-16
